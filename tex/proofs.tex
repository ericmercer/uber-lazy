\section{Proofs}

\subsection{Definitions}

\begin{definition}
A \textbf{state transition function} $\rightarrow_{\Phi}$ is a mapping $\rightarrow_{\Phi} : s \mapsto s$, which takes one machine state and transforms it into another machine state. 
\end{definition}

\begin{definition}
A \textbf{state sequence} is as a sequence of states denoted as $\Pi_n = s_0,s_1,...,s_n$. A \textbf{feasible state sequence}, $\Pi_n^\phi = s_0,s_1,...,s_n$ is consistent with the transition: $\forall i\ (0 \leq i < n \Rightarrow s_i \rightarrow_{\Phi} s_{i+1})$.
\end{definition}

\begin{comment}
\begin{definition}
A \textbf{feasible state sequence} is defined as a sequence of states resulting from repeated application of the state transition relation to some initial state $s_0$: $$\Pi_n = s_0,s_1,...,s_n$$ where the relation $s_i \rightarrow_{\Phi} s_{i+1}$ holds for all $i \in \{ i | 0 \leq i < n \}$
\end{definition}
\end{comment}

\begin{definition}
Given a sequence of states $$\Pi_n = s_0,s_1,...,s_n$$ where $$s_i = ( \mu_i\ \cfgnt{L}_i\ \cfgnt{R}_i\ \phi_i\ \eta_i\ \cfgnt{e}_i\ \cfgnt{k}_i )$$ the \textbf{control flow sequence} of $\Pi_n$ is the defined as the sequence of tuples $$ \pi_n = \mathbb{CF}(\Pi_n) = (\eta_0\ \cfgnt{e}_0\ \cfgnt{k}_0),(\eta_1\ \cfgnt{e}_1\ \cfgnt{k}_1),...,(\eta_n\ \cfgnt{e}_n\ \cfgnt{k}_n)$$
\end{definition}

\begin{definition}
Given a state transition function $\rightarrow_{\Phi}$, an initial state $s_0$ and a control flow sequence $\pi_n$, the \textbf{feasible state set}, $\mathbb{FS}(\rightarrow_{\Phi},s_0,\pi_n)$, is defined as
 $$
\begin{array}{l}
\mathbb{FS}(\rightarrow_{\Phi},s_0,\pi_n) = \\
\ \ \ \ \ \ \{s \mid \exists \Pi_n^\phi\ (\pi_n = \mathbb{CF}(\Pi_n^\Phi) \wedge s = \mathit{last}(\Pi_n))\} 
\end{array}
$$
where $\mathit{last}(\Pi_n)$ returns the last state on the feasible sequence.
\end{definition}

\begin{definition}
A \textbf{homomorphism} $s_x \rightharpoonup_{(g\ h)} s_y$, from state $s_x = ( \cfgnt{L}_x\ \cfgnt{R}_x\ \phi_x\ \eta_x\ \cfgnt{e}_x\ \cfgnt{k}_x )$ to state $s_y = ( \cfgnt{L}_y\ \cfgnt{R}_y\ \phi_y\ \eta_y\ \cfgnt{e}_y\ \cfgnt{k}_y )$, is defined as follows: 
%a pair of functions $g:\mathcal{R} \mapsto \mathcal{R}$ and $h: \mathcal{L} \mapsto \mathcal{L}$ such that the following conditions are met:

\begin{array}{l}
 s_x \rightharpoonup_{(g\ h)} s_y \Leftrightarrow \\
\ \ \ \ \ \ \ \ \exists g:\mathcal{R} \mapsto \mathcal{R}\ ( \exists h: \mathcal{L} \mapsto \mathcal{L}\ (\forall \cfgnt{r} \in \mathcal{R}\ (\forall \cfgnt{l} \in \mathcal{L}\ ( \\ 
\ \ \ \ \ \ \ \ \ \ \ \ (\phi_x\ \cfgnt{l}) \in \cfgnt{L}_x(\cfgnt{r}) \Rightarrow (\phi_y\ h(\cfgnt{l}))\in \cfgnt{L}_y(g(\cfgnt{r}))\ \wedge \\
\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \cfgnt{r} = \cfgnt{R}_x(\cfgnt{l},f) \Rightarrow g(\cfgnt{r}) = \cfgnt{R}_y(h(\cfgnt{l}),f) )) )) 
\end{array}

\begin{definition}
\label{representation}
The \textbf{representation relation} is defined as follows: given lazy state $s_\ell$ and summary state $s_s$, $s_\ell \sqsubset s_s $ if and only if $\eta_{\ell} = \eta_{s} ,\ \cfgnt{e}_{\ell} = \cfgnt{e}_{s} ,\ \cfgnt{k}_{\ell} = \cfgnt{k}_{s}$, and there exists a homomorphism $\ s_\ell \rightharpoonup_{(g\ h)} s_s $ such that if $$\chi = \{ \phi\ | \exists (r \in \cfgnt{R}_x,\  l \in \cfgnt{L}_x) ( (\phi\ h(l)) \in \cfgnt{L}_y (g(r))  \}$$ then 
\begin{equation}
\label{eqn:valid}
 \mathbb{S}( \phi_y \wedge (\bigwedge_{\phi_i \in \chi} \phi_i)) 
\end{equation}
\end{definition}

\begin{definition}
\label{congruent}
A summary state $s$ is \textbf{congruent} to a set of lazy states $P$ if and only if $s$ represents every state in $P$ and represents no other state: 
$$s \cong P \Leftrightarrow \forall s_i \in \mathcal{S}\ (s_i \in P \Leftrightarrow s_i \sqsubset s) $$
\end{definition}

\begin{definition}
\label{exact}
A state $s$ is \textbf{exact} with respect to a transition relation, $\rightarrow_\phi$, an initial state, $s_0$, and specific control flow path, $\pi_n$, if and only if it is congruent to the set of feasible state set:
$$ s \cong \mathbb{FS}(\rightarrow_{\phi},s_0,\pi)$$
\end{definition}

\subsection{Theorems}

\begin{theorem}
\label{thm:mutex}
In any symbolic state $s_s$, the constraints in the value set of any reference are mutually exclusive.
\end{theorem}
\begin{proof}
\end{proof}

\begin{lemma}
\label{lem:init}
If symbolic state $s_s = \lp \cfgnt{L}_{\mathcal{S}}\ \cfgnt{R}_{\mathcal{S}}\ \phi_g\ \eta\ \cfgnt{r}\ \lp \cfgt{*}\ \cfgt{\$}\ \cfgnt{f} \rightarrow \cfgnt{k}\rp \rp$ is exact with respect to some initial state $s_0$ and control flow path $\pi_n$, then the intermediate state state $s_f : s_s \rightarrow_S s_f$ is congruent to $\{\forall s_\ell^\prime | \exists s_\ell \sqsubset s_s (s_\ell \rightarrow_I^* s_\ell^\prime)  \}$.
\end{lemma}

\begin{proof}%going through this one quickly, could be more formal...
Given a lazy state $s_\ell \sqsubset s_s$, there are four distinct possibilities for $s_\ell^\prime$: either the field is already initialized, or the field is initialized to a new reference, the null reference, or an alias.

Case 1: Suppose the field is initialized. In this case, the rule does nothing and the theorem is trivially true.

%for the next case, we need to show that the constraints in the symbolic heap don't allow any infeasible heaps. The key to this will be in showing that the constraints are mutually exclusive and collectively exhaustive. Mutually exclusive constraints are required because lazy heaps only point to one place at at time. Collectively exhaustive constraints are required to eliminate any other possible heaps. We could start by explicitly enumerating the members of the product feasible set, and working from there to show that the symbolic heap is congruent to that set. Or, we might do this on a case-by-case basis to show that for an arbitrary lazy state, any of it's three possible target states is in the feasible set.

Case 2: The "new" rule gets executed. 

Case 3: The "null" rule gets executed.

Case 4: The "alias" rule gets executed.
\end{proof}

%we need to define how r' is arrived at for this one to work...
\begin{lemma}
If there are symbolic states $s_s$ and $s_s^\prime$, control sequences $\pi_n$ and $\pi_{n+1}$, initial state $s_0$, and reference $\cfgnt{r}^\prime$ such that the following conditions hold:
\begin{align}
s_s &= \lp \cfgnt{L}_{\mathcal{S}}\ \cfgnt{R}_{\mathcal{S}}\ \phi_g\ \eta\ \cfgnt{r}\ \lp \cfgt{*}\ \cfgt{\$}\ \cfgnt{f} \rightarrow \cfgnt{k}\rp \rp \\
s_s &\cong \mathbb{FS}\lp \rightarrow_{\phi},s_0,\pi_n\rp \\
\cfgnt{r}^\prime &= \mathrm{fresh}_r\lp \rp \\
\pi_{n+1} &=\pi_n\ \lp \eta\ \cfgnt{r}^\prime\ \cfgnt{k} \rp \\
s_s &\rightarrow_s s_s^\prime
\end{align}
%$$s_s = \lp \cfgnt{L}_{\mathcal{S}}\ \cfgnt{R}_{\mathcal{S}}\ \phi_g\ \eta\ \cfgnt{r}\ \lp \cfgt{*}\ \cfgt{\$}\ \cfgnt{f} \rightarrow \cfgnt{k}\rp \rp$$ 
%$$s_s \cong \mathbb{FS}\lp \rightarrow_{\phi},s_0,\pi_n\rp$$ 
%$$\pi_{n+1} =\pi_n\ \lp \eta\ \cfgnt{r}^\prime\ \cfgnt{k} \rp$$ 

then 
$$s_s^\prime \cong \mathbb{FS}\lp \rightarrow_{\phi},s_0,\pi_{n+1} \rp$$
\end{lemma}

\begin{proof}
We will consider two cases for this proof. In the first case, we assume that all of the fields involved in the read are initialized. In the second case we consider the case of uninitialized fields. 

Case 1: suppose all of the pertinent fields in $s_s$ are initialized. Take an arbitrary lazy state $s_\ell$ such that $s_\ell \sqsubset s_s$. Since $s_s$ is exact,  $s_\ell = \lp \cfgnt{L}_{\ell}\ \cfgnt{R}_{\ell}\ \phi_\ell\ \eta\ \cfgnt{r}\ \lp \cfgt{*}\ \cfgt{\$}\ \cfgnt{f} \rightarrow \cfgnt{k} \rp \rp$, and $s_\ell \in \mathbb{FS}(\rightarrow_{\ell},s_0,\pi_n)$. If we apply the state transition functions to achieve states $s_\ell^\prime$ and $s_s^\prime$ such that $s_\ell \rightarrow_\ell s_\ell^\prime$ and  $s_s \rightarrow_s s_s^\prime$, we find that:
$$s_\ell^\prime = \lp \cfgnt{L}_{\ell} [\cfgnt{r}^\prime \mapsto \lp\phi^\prime\ l^\prime\rp]\ \cfgnt{R}_{\ell}\ \phi_L\ \eta\ \cfgnt{r}^\prime\ \cfgnt{k}\rp $$
 and 
 $$ s_s^\prime = \lp \cfgnt{L}_{s}[\cfgnt{r}^\prime \mapsto \mathbb{VS}\lp \cfgnt{L}_{\mathcal{S}},\cfgnt{R}_{s},\cfgnt{r},\cfgnt{f},\phi_g\rp ]\ \cfgnt{R}_{\mathcal{S}}\ \phi_g\ \eta\ \cfgnt{r}^\prime\ \cfgnt{k}\rp $$

We now show that $s_\ell^\prime \sqsubset s_s^\prime$. Since $\eta$, $e$, and $k$ are identical between $s_s^\prime$ and $s_\ell^\prime $, the first condition is met by default. Now we construct functions $g^\prime$ and $h^\prime$ such that $g^\prime = g[ r^\prime \mapsto r^\prime]$ and $h^\prime = h$. Observe that since $s_\ell \rightharpoonup_{(g\ h)} s_s$, and since $\cfgnt{R}_\ell$ and $\cfgnt{R}_s$ are unchanged from states $s_\ell$ to $s_\ell^\prime$ and $s_s$ to $s_s^\prime$ respectively, we are guaranteed that $ r = \cfgnt{R}_\ell(l,f) \Rightarrow g^\prime(r) = \cfgnt{R}_s(h^\prime(l),f)$. Since $(\phi_\ell^\prime\ l^\prime) =  \cfgnt{L}_\ell(\cfgnt{R}_\ell(l,f))$, and since $(g\ h)$ is valid, we know that:
 $$(\phi_s \wedge \phi_s^\prime\ l^\prime) \in \mathbb{VS}\lp \cfgnt{L}_{\mathcal{S}},\cfgnt{R}_{s},\cfgnt{r},\cfgnt{f},\phi_g\rp$$ 
From this, we may deduce that:
$$ (\phi_\ell\ l) \in \cfgnt{L}_\ell^\prime(r^\prime) \Rightarrow (\phi_s \wedge \phi_s^\prime\ h^\prime(l))\in \cfgnt{L}_s^\prime(g^\prime(r^\prime))$$
Since $r^\prime$ the only new addition to $L_\ell^\prime$ and $L_s^\prime$, we now know that the assertion above holds for all $l \in \mathcal{L}$. Thus, we have shown that $s_\ell^\prime \rightharpoonup_{(g\ h)} s_s^\prime$. Furthermore, since $\mathbb{S}(\phi_s\wedge\phi_s^\prime\wedge \phi_g)$ evaluates to $\cfgt{true}$, we know that equation \ref{eqn:valid} also evaluates to $\cfgt{true}$. Since there is a valid heap homomorphism, and since $\eta_{\ell} = \eta_{s} ,\ \cfgnt{e}_{\ell} = \cfgnt{e}_{s} ,\ \cfgnt{k}_{\ell} = \cfgnt{k}_{s}$, we  by definition \ref{representation} know $s_\ell^\prime \sqsubset s_s^\prime$. We have now shown that for any lazy state $s_\ell$: 
$$s_\ell \in \mathbb{FS}(\rightarrow_{\ell},s_0,\pi_n) \Rightarrow s_\ell^\prime \sqsubset s_s^\prime$$

%there is a little hand-waving here. We claim that that a valid (g' h') implies a valid (g h), but the reason for this is actually pretty subtle and should probably be detailed better. Basically, it depends on the fact that the value set for the returned reference is contingent on the entire access path from the root of the heap. Another hand-wavy part is showing that the lazy machine will turn si into si'. Finally, we still need to show that if we run the lazy machine on every feasible state in si that we get every feasible state in si' .

Now, suppose that there exists a state $s_i^\prime$ such that $s_i^\prime \sqsubset s_s^\prime$, but $s_i^\prime \notin \mathbb{FS}(\rightarrow_{\ell},s_0,\pi_{n+1})$. Since $s_i^\prime \sqsubset s_s^\prime$, there must exist a valid homomorphism $s_i^\prime \rightharpoonup_{(g^\prime\ h^\prime)} s_s^\prime$. If $(g_i^\prime\ h_i^\prime)$ is valid, then there must also exist a valid homomorphism $(g_i\ h_i) : s_i \rightarrow s_s$, and by extension, state $s_i \sqsubset s_s$. However, since $s_s$ is exact, $s_i \in \mathbb{FS}(\rightarrow_{\ell},s_0,\pi_{n})$, and by our previous result, $s_i^\prime \in \mathbb{FS}(\rightarrow_{\ell},s_0,\pi_{n+1})$. We have a contradiction. Therefore, $$s_i^\prime \sqsubset s_s^\prime \Rightarrow s_i^\prime \in \mathbb{FS}(\rightarrow_{\ell},s_0,\pi_{n+1})$$ Combining the two previous equations, we find that 
$$s_\ell^\prime \in \mathbb{FS}(\rightarrow_{\ell},s_0,\pi_n) \Leftrightarrow s_\ell^\prime \sqsubset s_s^\prime)$$
By definition \ref{congruent}, $s_s^\prime \equiv \mathbb{FS}(\rightarrow_{\ell},s_0,\pi_n)$, and so by definition \ref{exact}, $s_s^\prime$ is exact.

Case 2: If there are uninitialized fields, then the lazy initialization machine will make an intermediate state $s_t$. By lemma \ref{lem:init}, the symbolic state is congruent to the set of lazy initialized states. From the intermediate state, the proof is the same as for case 1.
\end{proof}

%proof for field write
\begin{lemma}
The field write rule is correct.
\end{lemma}
\begin{proof}
\end{proof}

%proof for reference compares. Here we will rely on the fact that since the L and R functions don't change, and since the phi function
\begin{lemma}
If symbolic state $s_s =  \lp \cfgnt{L}_s\ \cfgnt{R}_s\ \phi_s\ \eta\ \cfgnt{r}_0\ \lp \cfgnt{r}_1\; \cfgt{=}\; \cfgt{*} \rightarrow \cfgnt{k}\rp \rp$ is exact with respect to some initial state $s_0$ and control flow path $\pi_n$, then the state $s_s^\prime : s_s \rightarrow_s s_s^\prime$ is exact with respect to $s_0$ and $\pi_{n+1}$.
\end{lemma}
There are two rules that apply to state $s_s$, one for the $\cfgt{true}$ branch and one for the $\cfgt{false}$ branch. Since the proofs for both rules are nearly identical, for clarity we will only prove the case for the $\cfgt{true}$ branch here. 
\begin{proof}
Choose any $s_\ell \sqsubset s_s$, and let $\zeta_T = \mathbb{FS}(\rightarrow_{\ell},s_0,(\pi_n,(\eta\ \cfgt{true}\ \cfgnt{k})))$. Since $s_s$ is exact, we know that $s_\ell \in \mathbb{FS}(\rightarrow_{\ell},s_0,\pi_n)$, $s_l = \lp \cfgnt{L}_\ell\ \cfgnt{R}_\ell\ \phi_\ell\ \eta\ \cfgnt{r}_0\ \lp \cfgnt{r}_1\; \cfgt{=}\; \cfgt{*} \rightarrow \cfgnt{k}\rp \rp$, and that there exists $(g\ h) : s_\ell \rightarrow s_s$. 
Depending on the values of $\cfgnt{L}_\ell \lp \cfgnt{r}_0\rp$ and $\cfgnt{L}_\ell \lp \cfgnt{r}_1 \rp$, there are two different rules that might apply to $s_\ell$.
%I'm not sure we actually use this fact anywhere
 %In either case, $\cfgnt{L}_\ell$ and $\cfgnt{R}_\ell$ are unchanged, and $\phi_\ell$ is strengthened, so we already know that 
%$$ \zeta_T \subseteq \{s_\ell^\prime | \exists s_\ell \in \mathbb{FS}(\rightarrow_{\ell},s_0,\pi_{n}) (s_\ell \rightarrow_\ell s_\ell^\prime )\}$$

Case 1: Assume $s_\ell : \cfgnt{L}_\ell \lp \cfgnt{r}_0\rp = \cfgnt{L}_\ell \lp \cfgnt{r}_1 \rp$, and let 
$$\zeta_t = \zeta_T \setminus \{ s_f | \cfgnt{L}_f \lp \cfgnt{r}_0\rp \neq \cfgnt{L}_f \lp \cfgnt{r}_1 \rp \}$$ In this case, the lazy ``equals - references true" rule applies, and we know state $s_\ell^\prime : s_\ell \rightarrow_\ell s_\ell^\prime$ is in $\zeta_t$. Since $(g\ h)$ is valid, we know that $\exists \lp \phi_0\ l \rp \in \cfgnt{L}_\ell\lp g \lp \cfgnt{r}_0\rp \rp$, $\exists \lp \phi_1\ l \rp \in \cfgnt{L}_\ell\lp g \lp \cfgnt{r}_1\rp \rp$, and that $\mathbb{S}\lp\phi_s\wedge\phi_0\wedge \phi_1\rp$ holds true. Observe that by applying theorem \ref{thm:mutex}, $\phi_s^\prime \wedge \phi_0 \wedge \phi_1$ reduces to $\phi_s$. Therefore, $\lp g\ h \rp: s_\ell^\prime \rightarrow s_s^\prime$ is a valid heap homomorphism, and by extension, $s_\ell^\prime \sqsubset s_s^\prime$. Since this relation holds for arbitrary $s_\ell^\prime \in \zeta_t$, we now know that $$s_\ell^\prime \in \zeta_t \Rightarrow s_\ell^\prime \sqsubset s_s^\prime$$
Now we prove the case for the other direction. Consider the state $s_s^\prime : s_s \rightarrow_s s_s^\prime$. Define $\theta_\alpha$, $\theta_0$ and $\theta_1$ as in the ``equals (references-true) rule''. Since $\cfgnt{L}_s$ and $\cfgnt{R}_s$ are unchanged from $s_s$, and $\phi_g$ is only strengthened,  we know that:
$$\{s_\ell^\prime | s_\ell^\prime \sqsubset s_s^\prime \} \subseteq \{s_\ell^\prime | \exists s_\ell \lp s_\ell \sqsubset s_s \rp \wedge s_\ell \rightarrow_s s_\ell^\prime\} $$
Suppose that there exists state $s_i^\prime$ such that $s_i^\prime \sqsubset s_s^\prime$ and $s_i^\prime \notin \zeta_t$. Because of the above conclusion, we know that $$s_i^\prime \in \{s_\ell^\prime | \exists s_\ell \lp s_\ell \sqsubset s_s\rp \wedge s_\ell \rightarrow_s s_\ell^\prime\}$$ Combining this with the assumption that $s_i^\prime \notin \zeta_t$, we must conclude that $\cfgnt{L}_\ell \lp \cfgnt{r}_0\rp \neq  \cfgnt{L}_\ell \lp \cfgnt{r}_1 \rp$. Because of this, and because of theorem \ref{thm:mutex}, we know that either all constraints $$\phi_i : \exists \phi_\alpha (\phi_\alpha \in \theta_\alpha)\wedge \phi_i = \lp\phi_\alpha \wedge \phi_0 \wedge \phi_1\rp$$ are unsatisfiable, or that at least one constraint $$\phi_i : \exists \phi_\alpha (\phi_\alpha \in \lp \theta_0 \cup \theta_1 \rp)\wedge \lp \phi_i = \phi_\alpha \wedge \phi_0 \wedge \phi_1 \rp$$ is valid. Either way, $\mathbb{S}\lp\phi_i^\prime \wedge\phi_0\wedge \phi_1\rp$ is false, $\lp g\ h\rp$ is not a valid homomorphism, and $s_s^\prime$ does not represent $s_i^\prime$. We have a contradiction. Therefore: $$s_\ell^\prime \sqsubset s_s^\prime \Rightarrow s_\ell^\prime \in \zeta_t$$
Combining this with our previous result, we conclude that $$s_\ell^\prime \in \zeta_t \Leftrightarrow s_\ell^\prime \sqsubset s_s^\prime$$

Case 2: Assume $s_\ell : \cfgnt{L}_\ell \lp \cfgnt{r}_0\rp \neq \cfgnt{L}_\ell \lp \cfgnt{r}_1 \rp$, and let 
$$\zeta_f = \zeta_T \setminus \{ s_t | \cfgnt{L}_t \lp \cfgnt{r}_0\rp = \cfgnt{L}_t \lp \cfgnt{r}_1 \rp \}$$ 
This means that the lazy ``equals - references false" rule applies. The proof for the ``equals - references false" rule is highly similar to the proof for ``equals - references true", so we omit it for the sake of brevity. The result for this case is:
$$s_\ell^\prime \in \zeta_f \Leftrightarrow s_\ell^\prime \sqsubset s_s^\prime$$

Since $\zeta_T = \zeta_t \cup \zeta_f$, we can combine the results of the two cases to find that $$s_\ell^\prime \in \zeta_T \Leftrightarrow s_\ell^\prime \sqsubset s_s^\prime$$. By definition \ref{congruent}, $s_s^\prime \equiv \zeta_T$, and by definition \ref{exact}, $s_s^\prime$ is exact.
\end{proof}

\begin{theorem}
Every symbolic state on every execution path is exact.
\end{theorem}
\begin{proof}
Combine all of the production-rule lemmas to inductively prove the theorem.
\end{proof}
